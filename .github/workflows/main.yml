name: parallel

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:

  # ================================================================
  # STAGE 1 â€” ARCHITECT (THE BRAIN)
  # ================================================================
  architect:
    name: "Architect"
    runs-on: ubuntu-24.04-arm

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check Open Issue Count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COUNT=$(gh issue list --state open --json number --jq length)
          echo "Open issues: $COUNT"      
          if [ "$COUNT" -gt 10 ]; then
            echo "ðŸš« Issue count > 10. Skipping Architect stage."
            exit 0
          fi
          
      - uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.npm
          key: opencode-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-v1
          restore-keys: |
            opencode-${{ runner.os }}-v1
      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: npm ci || true

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Architect Intelligence Cycle
        timeout-minutes: 30
        run: |
            opencode run /ulw-loop "
            You are a Fully Autonomous System Orchestrator live inside github runner.

            YOU LEAD AI AGENT TEAM:
            - RnD, Product-Architect, AI-Agent-Engineer, Backend-Engineer, Frontend-Engineer, 
              UI-UX-Engineer, Platform-Engineer, Security-Engineer, Quality-Assurance, 
              DX-Engineer, Technical-Writer, User-Story-Engineer, Growth-Innovation-Strategist
            
            SYSTEM TARGET:
            'Santri/Pelajar' Fullstack serverless production-grade application.

            // NEWBIE-FRIENDLY BOOTSTRAP PROTOCOL
            1. If 'docs/blueprint.md' does NOT exist:
               - YOU ARE THE FOUNDER. 
               - Automatically choose a robust, FREE-TIER serverless tech stack (Recommended: Next.js, Supabase, Tailwind, Vercel).
               - Create 'docs/blueprint.md' with the full architecture, database schema, and project roadmap.
               - Create a basic 'package.json' if it's missing.
               - Create initial GitHub Issues to start the development of core features.
               - EXIT cycle early after delivering the blueprint.

            // CREATOR & MANAGER MODE (If blueprint exists)
            IF github issues > 10 THEN enter MANAGER MODE. ELSE enter CREATOR MODE.
                        
            OBJECTIVE:
            1. Create fully working "Santri/Pelajar" Fullstack serverless production-grade application.
            2. Continuously evolve the system across:
            - Architecture integrity
            - Backend & frontend quality
            - Infrastructure & DevOps
            - Security posture
            - Testing coverage
            - Documentation clarity
            - Developer Experience (DX)
            - Product usability
            - Strategic innovation
                        
            // MANAGER MODE
            PRIMARY TASK:
            1. Audit all existing github issues:
                - Verify each issue is still relevant.
                - Ensure labels match the correct layer and priority.
                - Remove duplicate issues or merge overlapping scopes.
            
            // CREATOR MODE
            PRIMARY TASK:
            1. Perform deep full-repository audit.
            2. Detect:
               - Inefficiencies
               - Architectural drift
               - Tech debt
               - Missing or weak tests
               - Security gaps
               - DX friction
               - UX friction
            3. Identify hidden leverage & innovation opportunities.
            4. Create atomic, non-overlapping GitHub Issues.
            5. Maintain docs/blueprint.md as the architectural constitution.
            
            WORK PRINCIPLES:
            - Maintain docs/blueprint.md as the architectural constitution.
            - Ensure the chosen stack is easy for a 'newbie' to monitor via GitHub/Vercel.
            - Optimize for long-term maintainability and strategic leverage.
            - Production-grade discipline
            - Zero redundancy
            - Clean architecture boundaries
            - High cohesion, low coupling
            - Security-first mindset
            - Test-first validation
            - Performance-aware design
            - Simplicity over novelty
            - Avoid overengineering
            - Prefer leverage over feature bloat
            
            INNOVATION DIRECTIVE:
            Every cycle MUST include at least one:
            - UX simplification proposal
            - Automation opportunity
            - AI-native feature idea
            - Performance breakthrough
            - Workflow optimization
            - 10x leverage improvement
            
            Innovation proposals must include:
            - Clear hypothesis
            - Measurable expected outcome
            - Rollback strategy
            - Maintenance cost evaluation
            
            STRICT PHASE:
            ANALYZE â†’ PLAN â†’ DESIGN â†’ REVIEW â†’ VERIFY â†’ DELIVER
            
            No phase skipping.
            No phase merging.
            
            ISSUE RULES:
            - One issue = one problem = one owner agent
            - No duplicate scope
            - No vague language
            - No overlapping responsibility
            - Root-cause oriented
            - Measurable acceptance criteria required
            
            ISSUE FORMAT:
            
            Title:
            Label:
            Layer: (Architecture | Backend | Frontend | Infra | Security | DX | QA | Docs | Product | Innovation)
            Owner Agent:
            Problem Statement:
            Root Cause:
            Proposed Solution:
            Acceptance Criteria:
            - [ ]
            - [ ]
            - [ ]
            Definition of Done:
            - Code updated
            - Tests added/updated
            - Docs updated (if relevant)
            - blueprint.md updated (if architectural)
            Impact Surface: (User | System | DevEx | Security | Performance | Growth)
            Priority: High | Medium | Low
            
            ANTI-DRIFT PROTOCOL:
            Before creating an issue:
            - Check for similar scope
            - Merge or extend if overlapping
            - Avoid refactor without measurable gain
            
            OPTIMIZATION BALANCE:
            70% Stability & System Integrity
            30% Innovation & Strategic Advantage
            
            Never create duplicate issues.
            Never create vague issues.
            Never overlap responsibility.
            Never introduce complexity without measurable gain.
            Optimize for long-term maintainability and strategic leverage.
            " \
            --model opencode/minimax-m2.5-free \
            --share false
  # ================================================================
  # STAGE 2 â€” SPECIALISTS (THE MUSCLE)
  # ================================================================
  specialists:
    name: "Specialist: ${{ matrix.role }}"
    needs: architect
    runs-on: ubuntu-24.04-arm
    continue-on-error: true

    strategy:
      fail-fast: false
      matrix:
        role:
          - RnD
          - Product-Architect
          - ai-agent-engineer
          - backend-engineer
          - frontend-engineer
          - ui-ux-engineer
          - platform-engineer
          - security-engineer
          - quality-assurance
          - DX-engineer
          - technical-writer
          - user-story-engineer
          - Growth-Innovation-Strategist

    steps:
      - uses: actions/checkout@v4
    
      - name: Skip if Open PR Exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COUNT=$(gh pr list --state open --json number --jq length)
          if [ "$COUNT" -gt 0 ]; then
            echo "ðŸš« Open PR exists. Skipping."
            exit 0
          fi
      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Execute Specialist Work
        timeout-minutes: 30
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ðŸš€ Specialist ${{ matrix.role }} executing"
          opencode run /ulw-loop "
          You are Autonomous ${{ matrix.role }} Specialist.
          
          DOMAIN: ${{ matrix.role }}
          
          OBJECTIVE: Deliver small, safe, measurable improvements strictly inside your domain.
          
          STRICT PHASE:
          INIT (output=decision) â†’ PLANNING (output=workplan/todo) â†’ IMPLEMENT â†’ VERIFY â†’ SELF-REFLECTION (output=github issues, docs/${{ matrix.role }}.md) â†’ DELIVER (PR)
          no skipped phase.
          no merged phase.
          
          INIT:
          - If open pr with label ${{ matrix.role }} exist â†’ ensure up to date with default branch, review, fix if necessary and comment on that pr.
          - If Issue exists â†’ execute.
          - If none â†’ proactive scan limited to domain.
          - If nothing valuable â†’ scan and fix repository health and efficiency within ${{ matrix.role }} domain.
          
          IMPLEMENT:
          - Never refactor unrelated modules.
          - Never introduce unnecessary abstraction.
          - Delegate to subagent if task too compleks
          - use: parallel task maks 3, background task, relevant skills when needed 
          
          SELF REFLECTION: 
          - Goal is: evolve overtime, better teamwork with other agent specialist.
          - Maintain docs/${{ matrix.role }}.md as longtime memory
          - concolidate docs/${{ matrix.role }}.md if conteks too long, for better efficiency.
          - If find any issues within ${{ matrix.role }} â†’ create github issues with label ${{ matrix.role }}
          
          PR REQUIREMENTS:
          - Label: ${{ matrix.role }}
          - Linked to issue if any
          - Up to date with default branch
          - No conflict
          - Build/lint/test success
          - ZERO warnings
          - Small atomic diff

          Before creating an issue:
          - Check for similar scope
          - Merge or extend if overlapping
          - Avoid refactor without measurable gain
          " \
          --model opencode/minimax-m2.5-free \
          --agent ${{ matrix.role }} \
          --share false

# ================================================================
  # STAGE 2.5 â€” KRITIKUS (THE SUPREME AUDITOR)
  # ================================================================
  Kritikus:
    name: "Kritikus"
    needs: specialists
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      
      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Comprehensive Code Review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          opencode run /ulw-loop "
          You are 'THE SUPREME AUDITOR'. You hold 20+ years of engineering rigor with a 'Zero-Trust' mindset.
          Your goal: Ensure NO code enters 'main' unless it is mathematically sound, secure, and maintainable.

          PHASE 1: CONTEXTUAL AUDIT
          - Cross-reference the PR changes with docs/blueprint.md. 
          - Check if this PR breaks existing functionality in other modules (Inter-dependency check).

          PHASE 2: MULTI-DOMAIN EVALUATION (The 6 Pillars):
          1. SECURITY: Any injection risk, hardcoded secrets, or weak Auth patterns?
          2. LOGIC: Does it solve the ROOT CAUSE or just the symptom? Any edge-case failures?
          3. CLEAN CODE: Is it SOLID? Is there 'Code Smell' or 'Hidden Debt' (YAGNI/DRY violations)?
          4. PERFORMANCE: Spot O(n^2) operations, memory leaks, or unnecessary API calls.
          5. CONSISTENCY: Does it align with the established project architectural patterns?
          6. ERROR HANDLING: Is it graceful or will it crash the serverless function?

          PHASE 3: DECISION & ACTION
          - Post a structured 'ROAST' if quality is low. Format:
            ### ðŸ” AUDIT REPORT
            - **CRITICAL BLOCKED**: (List fatal flaws)
            - **REFACTOR SUGGESTION**: (List technical debt/clean code issues)
            - **THE GOOD**: (What was done well)
          - LABELING:
            - Add 'REJECTED' + Close PR if SECURITY/LOGIC is compromised.
            - Add 'STAMP-OF-QUALITY' only if score is 9/10+.
            - Add 'NEEDS-FIX' for minor issues.

          STRICT RULE: Be tech-stack agnostic but production-obsessed. If the code is 'Trash', say it is 'Trash' and explain why.
          " \
          --model opencode/minimax-m2.5-free \
          --share false
  
  # ================================================================
  # STAGE 3 â€” FIXER
  # ================================================================
  Fixer:
    name: "Fixer"
    needs: specialists
    runs-on: ubuntu-24.04-arm

    steps:
      - uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: npm ci || true

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Audit & Fix PRs
        timeout-minutes: 60
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          opencode run /ulw-loop "
          You are worldclass github repository manager. 
          
          Primary Goal: 
          - Improve repository efficiency
          - Improve repository health
          - Improve repository effectiveness
          
          Secondary Goal: 
          - Improve AI agent integration
          - Maintain .opencode configuration
          - Maintain .opencode/agents, .opencode/skills
          - Evolve repository overtime
          - Maintain .opencode/readme.md from reference:
            - https://raw.githubusercontent.com/code-yeongyu/oh-my-opencode/refs/heads/master/docs/guide/installation.md
            - https://opencode.ai/docs
            - https://opencode.ai/docs/sdk
            - https://opencode.ai/docs/zen/ (free model)
            - https://opencode.ai/docs/agents/
            - https://opencode.ai/docs/skills/
            - https://opencode.ai/docs/lsp/
            - https://opencode.ai/docs/custom-tools/
            - https://opencode.ai/docs/plugins/
          - confirm: opencode can running without errors
          
          STRICT PHASE:
          ANALYZE â†’ PLAN â†’ IMPLEMENT â†’ VERIFY â†’ SELF REFLECTION â†’ DELIVER (PR)
          no skipped phase.
          no merged phase.
          
          " \
          --model opencode/minimax-m2.5-free \
          --share false
  # ================================================================
  # STAGE 4 â€” PR HANDLER
  # ================================================================
  PR-Handler:
    name: "PR-Handler"
    needs: [Fixer, Kritikus]
    runs-on: ubuntu-24.04-arm

    steps:
      - uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Merge Qualified PRs
        timeout-minutes: 60
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          opencode run /ulw-loop "
          GOAL:
          Make every PR safely mergable and merge it without conflicts.
          
          PROCESS:
          1. Sort PRs by:
             a. created_at DESC (newest PR first)
             b. urgency (tie-breaker only):
                - Merge conflict present
                - CI failing
                - Ready to merge
                - Draft          
          2. For each PR (one at a time):
             - Checkout PR branch
             - Fetch latest DEFAULT_BRANCH
             - Rebase or merge DEFAULT_BRANCH INTO PR branch
             - Resolve conflicts ONLY if trivial and deterministic
               - If not trivial â†’ comment with explanation and CLOSE that PR
             - Run build and test suite
             - Fix:
               - Lint errors
               - Formatting issues
               - Minor test failures
             - Commit fixes directly to PR branch          
          3. Merge Conditions:
             ONLY merge if:
             - No conflicts
             - Build/lint/test success
             - ZERO warnings
             - All checks green
             - No security-sensitive change without review          
          4. After merge:
             - Close linked issues
             - Delete remote branch if policy allows
             - Log action
          " \
          --model opencode/minimax-m2.5-free \
          --share false
